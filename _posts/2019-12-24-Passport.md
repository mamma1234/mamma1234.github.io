---
layout: post
title: "Passport"
description: 
headline: 
modified: 2019-12-24
category: webdevelopment
imagefeature: cover3.jpg
tags: [Passport]
mathjax: 
chart: 
share: true
comments: true
featured: true
disqus:
---


# Passport



## Introduction
-  

## 필수 모듈 설치
- yarn add cookie-parser cookie-session express-session morgan connect-flash pug

- yarn add dotenv

- yarn add passport passport-local passport-facebook passport-kakao passport-naver passport-google-oauth20

- yarn add passport-daum-oauth2 passport-twitter-oauth2 passport-cognito-oauth2 passport-instagram passport-linkedin-oauth2


## Passport 설정

- server.js
```JavaScript
var passport = require('passport') //passport module add
  , LocalStrategy = require('passport-local').Strategy;
var cookieSession = require('cookie-session');
var flash = require('connect-flash');

app.use(cookieSession({
  keys: ['node_yun'],
  cookie: {
    maxAge: 1000 * 60 * 60 // 유효기간 1시간
  }
}));
app.use(flash());
app.use(passport.initialize());
app.use(passport.session());

passport.initialize(), passport.session() 통해서 passport를 미들뒈어로 등록시킵니다. cookieSession을 Request 객체를 통해 Session을 핸들링할 수 있게 설정합니다. 만료기간 및 쿠키 키 값은 각자의 프로젝트에 맞게 설정하시면 됩니다.
```

- login.html
```JavaScript
<form action="/login" method="post" name="frm_login" id="frm_login">
    <input type="text" name="username" />
    <input type="password" name="password"/>
    <input type="submit"  value="Login"/>
</form>
```

- server.js Router 설정
```JavaScript
var passport = require('passport')
  , LocalStrategy = require('passport-local').Strategy;

router.post('/login', passport.authenticate('local', {failureRedirect: '/login', failureFlash: true}), // 인증 실패 시 401 리턴, {} -> 인증 스트레티지
  function (req, res) {
    res.redirect('/home');
  });

  login.html에서 post로 전송되면 이쪽에서 캐치하고 다음 작업을 진행하게 됩니다. passport.authenticate를 local strategy로 호출합니다. 이 호출은 아래에서 설명하겠습니다. failureRedirect를 통해서 로그인 실패 시 어디로 리다이렉트 할 것인지를 설정하고, 만약 로그인을 성공하게 되면 res.redirect를 통해 home으로 리다이렉트 시킵니다.
```

- LocalStrategy 
```JavaScript
passport.use(new LocalStrategy({
  usernameField: 'username',
  passwordField: 'password',
  passReqToCallback: true //인증을 수행하는 인증 함수로 HTTP request를 그대로  전달할지 여부를 결정한다
}, function (req, username, password, done) {
  if(username === 'user001' && password === 'password'){
    return done(null, {
      'user_id': username,
    });
  }else{
    return done(false, null)
  }
}));
```


- serializeUser
```JavaScript
passport.serializeUser(function (user, done) {
  done(null, user)
});

로그인에 성공할 시 serializeUser 메서드를 통해서 사용자 정보를 Session에 저장하게 됩니다. 본 예제에는 “‘user_id’: username” 의값이 user에 들어가고 이 값을 Session에 저장하게 됩니다.

```

- deserializeUser
```JavaScript
passport.deserializeUser(function (user, done) {
  done(null, user);
});

로그인에 성공하게 되면 Session정보를 저장을 완료했기에 이제 페이시 접근 시마다 사용자 정보를 갖게 Session에 갖게 됩니다. 인증이 완료되고 페이지 이동시 deserializeUser 메서드가 호출되는 것을 로그를 찍어 보시면 확인할 수 있습니다.

```


## 로그인 유저 판단

