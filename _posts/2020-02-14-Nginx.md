---
layout: post
title: "Nginx"
description: 
headline: 
modified: 2020-02-14
category: webdevelopment
imagefeature: cover3.jpg
tags: [Nginx]
mathjax: 
chart: 
share: true
comments: true
featured: false
disqus:
---
# Nginx

## React를 Nginx웹 서버에 배포하기
 - yarn build
 - npm run build


## Windows
```
C:\github\mamma1234\nginx-1.17.8\conf\nginx.conf

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   C:\github\mamma1234\klnet.owner\klnet.owner.web\material-react-mobx\build;
            index  index.html index.htm menu.html;
            try_files $uri $uri/ /index.html;
        }


```

## 기본 파일, 폴더
- sites-available : 가상 서버 환경들에 대한 설정 파일들이 위치하는 부분입니다. 가상 서버를 사용하거나 사용하지 않던간에 그에 대한 설정 파일들이 위치하는 곳이다.
- sites-enabled : sites-available 에 있는 가상 서버 파일들중에서 실행시키고 싶은 파일을 symlink로 연결한 폴더입니다. 실제로 이 폴더에 위치한 가상서버 환경 파일들을 읽어서 서버를 세팅합니다.
- nginx.conf : Nginx에 관한 설정파일로 Nginx 설정에 관한 블록들이 작성되어 있으며 이 파일에서 sites-enabled 폴더에 있는 파일들을 가져옵니다.



## 명령어
```JavaScript
    서버 시작 : nginx
    서버 중지 : nginx -s stop
    서버 재시작 : nginx -r reload
```

## Nginx 로드밸런싱 설정
```JavaScript
    #http블럭 내부에 추가
        #NodeJS 서버 로드밸런싱
        upstream nodejs_server {
            #least_conn;
            #ip_hash;
            server localhost:3000 weight=10 max_fails=3 fail_timeout=10s;
            server localhost:3001 weight=10 max_fails=3 fail_timeout=10s;
        }
    
        #3333번 포트 NodeJS 서버로 연결
        server{
            listen                3333;
            server_name  localhost;
        
            location / {
                proxy_pass http://nodejs_server;
            }
        }
```


ip_hash : 동일한 IP의 접속은 같은 서버로 접속하도록 하는 옵션입니다.
least_conn : 가장 접속이 적은 서버로 접속을 유도하는 옵션으로 ip_hash와 같이쓰입니다.


## Nginx 멀티 location 설정
```JavaScript
server {
    listen 80;
    index index.html;
    server_name localhost;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /usr/share/nginx/html;

    location ~* /api {
        proxy_pass http://server:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location ~* /pg {
        proxy_pass http://server:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location ~* /auth {
        proxy_pass http://server:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location ~* /ora {
        proxy_pass http://server:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }


    location ~* /own {
        proxy_pass http://server:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    location / {
            root /usr/share/nginx/html;
            index index.html index.htmi menu.html;
            try_files $uri $uri/ /index.html;
    }

    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
            root /usr/share/nginx/html;
    }
}
```



## Nginx 프록시 설정
```JavaScript
# nginx/default.conf

upstream client {
    server client:3000;
}

upstream server {
    server server:3050;
}

server {
    listen 80;

    location / {        
        proxy_pass http://client;
    }

    location /sockjs-node {
        proxy_pass http://client;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location /api {
        rewrite /api/(.*) /$1 break;
        proxy_pass http://server;
    }
}

```